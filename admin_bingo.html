<!DOCTYPE html>
<html lang="da">

<head>
    <meta charset="UTF-8">
    <title>Bingo Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preload" href="./fonts/Geomanist-Regular.otf" as="font" type="font/otf" crossorigin>
    <link rel="preload" href="./fonts/Geomanist-Bold.otf" as="font" type="font/otf" crossorigin>
    <style>
        @font-face {
            font-family: 'Geomanist';
            src: url('./fonts/Geomanist-Regular.otf') format('opentype');
            font-weight: 400;
        }

        @font-face {
            font-family: 'Geomanist';
            src: url('./fonts/Geomanist-Bold.otf') format('opentype');
            font-weight: 700;
        }

        :root {
            --smuk-green: #037D51;
            --smuk-dust: #F1E1D6;
            --smuk-dark: #2d3e2a;
            --smuk-yellow: #facc15;
        }

        body {
            font-family: 'Geomanist', sans-serif;
            background-color: var(--smuk-dust);
            padding: 2rem;
            color: var(--smuk-dark);
            max-width: 700px;
            margin: auto;
        }

        h1,
        h2,
        h3 {
            color: var(--smuk-green);
        }

        input,
        button {
            font-family: 'Geomanist';
            padding: 0.6rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }

        button {
            background-color: var(--smuk-green);
            color: white;
            cursor: pointer;
        }

        .number-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .number-grid div {
            width: 40px;
            height: 40px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 6px;
            border: 2px solid var(--smuk-green);
            cursor: pointer;
        }

        .called-number.selected {
            background-color: var(--smuk-green);
            border-color: var(--smuk-dark);
        }

        .result {
            margin-top: 1rem;
            font-weight: bold;
        }

        .winners-list {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            min-height: 40px;
        }

        .winner-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: var(--smuk-dust);
            border-radius: 4px;
            border-left: 4px solid var(--smuk-green);
        }

        .winner-entry:last-child {
            margin-bottom: 0;
        }

        .winner-email {
            font-weight: 600;
        }

        .winner-time {
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>

<body>
    <h1>üß† Bingo Admin</h1>

    <h2>Tilf√∏j trukket tal</h2>
    <input type="number" id="newNumber" min="1" max="90" placeholder="Tal 1-90">
    <button onclick="submitNumber()">Tilf√∏j</button>

    <h3>Udtrukne tal (klik for at v√¶lge)</h3>
    <div id="calledNumbers" class="number-grid">Indl√¶ser...</div>
    <button onclick="removeSelectedNumber()">Fjern valgt tal</button>

    <hr>

    <h2>Tjek plade</h2>
    <input type="email" id="checkEmail" placeholder="Email">
    <button onclick="checkPlate()">Tjek plade</button>
    <div id="checkResult" class="result"></div>

    <hr>

    <h2>Vindere</h2>
    <div id="winnersSection">
        <h3 style="color: var(--smuk-yellow);">üèÜ Fuld plade (Bingo)</h3>
        <div id="bingoWinners" class="winners-list">Ingen vindere endnu</div>
        
        <h3 style="color: var(--smuk-green);">ü•à 2 r√¶kker</h3>
        <div id="twoRowWinners" class="winners-list">Ingen vindere endnu</div>
        
        <h3 style="color: #666;">ü•â 1 r√¶kke</h3>
        <div id="oneRowWinners" class="winners-list">Ingen vindere endnu</div>
    </div>

    <hr>
    <h2>Nulstil spil</h2>
    <button onclick="resetGame()">üîÑ Start nyt spil</button>
    <div id="resetStatus" class="result"></div>


    <script>
        let selectedNumber = null;

        async function loadCalledNumbers() {
            const res = await fetch('/.netlify/functions/get-called-numbers');
            const { numbers } = await res.json();
            const container = document.getElementById("calledNumbers");
            container.innerHTML = "";

            numbers.forEach(n => {
                const div = document.createElement("div");
                div.textContent = n;
                div.className = "called-number";
                if (n === selectedNumber) div.classList.add("selected");

                div.onclick = () => {
                    selectedNumber = n === selectedNumber ? null : n;
                    loadCalledNumbers(); // re-render to reflect selection
                };

                container.appendChild(div);
            });
        }

        async function submitNumber() {
            const num = parseInt(document.getElementById("newNumber").value);
            if (!num || num < 1 || num > 90) return;
            await fetch('/.netlify/functions/add-called-number', {
                method: 'POST',
                body: JSON.stringify({ number: num }),
                headers: { 'Content-Type': 'application/json' }
            });
            document.getElementById("newNumber").value = "";
            loadCalledNumbers();
            loadWinners(); // Update winners after adding a new number
        }

        async function removeSelectedNumber() {
            if (!selectedNumber) return alert("V√¶lg f√∏rst et tal, der skal fjernes.");
            if (!confirm(`Fjern tallet ${selectedNumber}?`)) return;

            await fetch('/.netlify/functions/remove-called-number', {
                method: 'POST',
                body: JSON.stringify({ number: selectedNumber }),
                headers: { 'Content-Type': 'application/json' }
            });
            selectedNumber = null;
            loadCalledNumbers();
            loadWinners(); // Update winners after removing a number
        }

        async function checkPlate() {
            const email = document.getElementById("checkEmail").value;
            if (!email) return;
            
            const res = await fetch('/.netlify/functions/check-plate-status?email=' + encodeURIComponent(email));
            const data = await res.json();
            document.getElementById("checkResult").textContent = data.result || data.error;
            
            // Reload winners after checking a plate
            if (data.result && data.result.includes("vinder")) {
                loadWinners();
            }
        }

        async function loadWinners() {
            try {
                const res = await fetch('/.netlify/functions/get-winners');
                const data = await res.json();
                
                displayWinners('bingoWinners', data.bingo || [], 'Fuld plade');
                displayWinners('twoRowWinners', data.twoRows || [], '2 r√¶kker');
                displayWinners('oneRowWinners', data.oneRow || [], '1 r√¶kke');
            } catch (error) {
                console.error('Fejl ved indl√¶sning af vindere:', error);
            }
        }

        function displayWinners(containerId, winners, type) {
            const container = document.getElementById(containerId);
            
            if (winners.length === 0) {
                container.innerHTML = `<em>Ingen ${type.toLowerCase()} vindere endnu</em>`;
                return;
            }
            
            container.innerHTML = winners.map(winner => `
                <div class="winner-entry">
                    <span class="winner-email">${winner.email}</span>
                    <span class="winner-time">${new Date(winner.timestamp).toLocaleString('da-DK')}</span>
                </div>
            `).join('');
        }

        loadCalledNumbers();
        loadWinners(); // Load winners on page load

        // Add Enter key support for adding numbers
        document.getElementById('newNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitNumber();
            }
        });

        async function resetGame() {
            const confirmed = confirm("Er du sikker p√•, at du vil starte et nyt spil? Dette vil slette alle udtrukne tal og vindere!");
            if (!confirmed) return;

            const res = await fetch('/.netlify/functions/reset-game', { method: 'POST' });

            if (res.ok) {
                document.getElementById("resetStatus").textContent = "Spillet er nulstillet!";
                loadCalledNumbers(); // opdater visning
                loadWinners(); // opdater vindere
            } else {
                document.getElementById("resetStatus").textContent = "Fejl under nulstilling.";
            }
        }

    </script>
</body>

</html>